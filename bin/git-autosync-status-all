#!/bin/bash

set -e

if [ -z "$1" ]; then
    REPO="$1"
else
    REPO="."
fi
cd "$REPO"

git fetch git-autosync

REPODIR=$(git rev-parse --show-toplevel)
REPONAME=$(basename "$REPODIR")

GIT=$(cat ~/".git-autosync/worktrees/$REPONAME/.git")
export GIT_DIR="${GIT#*: }"
git add -A

for BRANCH in $(git branch -r -l 'git-autosync/git-autosync-*'); do
    BASE=$(basename "$BRANCH")
    RELATIVE=$(git rev-list --left-right --count "HEAD...${BRANCH}")

    printf "== Branch: %s\n" "$BASE"
    BRANCH="git-autosync-$(hostname)"
    git diff --name-status "${BRANCH}"
    printf "\n"

    #printf "%s: is %s commits behind, %s commits ahead of HEAD.\n" "$BASE" $RELATIVE
    #git diff "${BRANCH}"
    #printf "%s: is %s commits behind, %s commits ahead of HEAD.\n" "$BASE" $RELATIVE
done
